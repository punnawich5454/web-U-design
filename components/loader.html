<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>Loader</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader {
            position: relative;
            width: 200px;
            height: 200px;
            /* background: url('/assets/images/logoNoColor.png') no-repeat center/contain; */
            border-radius: 20px;
            overflow: hidden;
        }

        .fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background-color: #a3d400;
            opacity: 0.85;
            border-radius: 20px 20px 20px 20px;
            clip-path: polygon(0 100%, 0 0, 100% 0, 100% 100%);
            z-index: 0;
            transition: ease 0.3s;
        }
    </style>
</head>

<body>
    <div class="loader">
        <div class="fill" id="fill"></div>
        <img src="/assets/images/logoNoColor.png" alt="logo"
            style="width:100%;height:100%;position:absolute;top:0;left:0;z-index:1;pointer-events:none;user-select:none;"
            draggable="false">
    </div>

    <script>
        const fill = document.getElementById('fill');

        const API = 'https://wed-u-design-backend-production-65e0.up.railway.app'

        const apis = [
            API + '/api/banners',
            API + '/api/categories',
            API + '/api/visit'
        ];

        const totalApis = apis.length;
        let loadedApis = 0;

        function updateFill() {
            const percent = (loadedApis / totalApis) * 100;
            fill.style.height = percent + '%';
        }

        function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const signal = controller.signal;

            const timer = setTimeout(() => controller.abort(), timeout);

            return fetch(url, { signal }).finally(() => clearTimeout(timer));
        }


        async function loadAllAPIsWithTimeout() {
            let finished = false;
            const promises = apis.map(url =>
                fetchWithTimeout(url)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.json();
                    })
                    .catch(err => {
                        console.error('โหลด API ล้มเหลว:', url, err);
                    })
                    .finally(() => {
                        loadedApis++;
                        updateFill();
                    })
            );

            // ตั้ง timeout รวม 8 วินาที
            const overallTimeout = setTimeout(() => {
                if (!finished) {
                    finished = true;
                    parent.postMessage({ type: 'loaderFinished', reason: 'timeout' }, '*');
                }
            }, 8000);

            await Promise.allSettled(promises);
            if (!finished) {
                finished = true;
                clearTimeout(overallTimeout);
                parent.postMessage({ type: 'loaderFinished', reason: 'allAPIs' }, '*');
            }
        }

        loadAllAPIsWithTimeout();



    </script>
</body>

</html>