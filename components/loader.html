<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>Loader</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader {
            position: relative;
            width: 200px;
            height: 200px;
            background: url('/assets/images/logoNoColor.png') no-repeat center/contain;
        }

        .fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background-color: #a3d400;
            clip-path: polygon(0 100%, 0 0, 100% 0, 100% 100%);
            z-index: -1;
            transition: ease 0.3s;
        }
    </style>
</head>

<body>
    <div class="loader">
        <div class="fill" id="fill"></div>
    </div>

    <script>
        const fill = document.getElementById('fill');

        const API = 'http://127.0.0.1:3000'

        const apis = [
            API + '/api/banners',
            API + '/api/visit'
        ];

        const totalApis = apis.length;
        let loadedApis = 0;

        function updateFill() {
            const percent = (loadedApis / totalApis) * 100;
            fill.style.height = percent + '%';
        }

        function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const signal = controller.signal;

            const timer = setTimeout(() => controller.abort(), timeout);

            return fetch(url, { signal }).finally(() => clearTimeout(timer));
        }

        async function loadAllAPIs() {
            const promises = apis.map(url =>
                fetchWithTimeout(url)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.json();
                    })
                    .catch(err => {
                        console.error('โหลด API ล้มเหลว:', url, err);
                    })
                    .finally(() => {
                        loadedApis++;
                        updateFill();
                    })
            );

            await Promise.allSettled(promises);

            // แจ้ง parent ว่าโหลดเสร็จ
            parent.postMessage({ type: 'loaderFinished' }, '*');
        }

        loadAllAPIs();



    </script>
</body>

</html>